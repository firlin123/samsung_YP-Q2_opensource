/////////////////////////////////////////////////////////////////////////////////
// Copyright(C) 2005-2008 SigmaTel, Inc.
//
//! \file ddi_clocks_xbus.c
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Includes
/////////////////////////////////////////////////////////////////////////////////
#include "ddi_clocks_common.h"

/////////////////////////////////////////////////////////////////////////////////
// Externs
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Definitions
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Variables
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Code
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
//! 
//! \brief Sets the Xclk frequency  
//!
//! \fntype Function
//!
//! This function will set the Xclk frequency as close as possible to the requested
//! frequency.  The 24MHz crystal will be always be used as the source.  The maximum
//! frequency will be 24MHz and the lowest will be 1kHz.
//!
//! \param[in] pu32ReqFreq - requested Xclk frequency in kHz (1kHz to 24MHz range)
//!
//! \param[out] pu32ReqFreq - actual kHz frequency Xclk was set to
//!
//! \retval ERROR_DDI_CLOCKS_INVALID_XCLK_FREQ - Xclk range exceeded
//! \retval SUCCESS 
/////////////////////////////////////////////////////////////////////////////////
RtStatus_t ddi_clocks_SetXclk(uint32_t* u32Freq_kHz)
{
    RtStatus_t rtn;
    uint32_t u32XclkFreq = *u32Freq_kHz;
    uint32_t u32IntDiv;

    //--------------------------------------------------------------------------
    // Check for errors
    //--------------------------------------------------------------------------
    if((u32XclkFreq > MAX_XCLK) || (u32XclkFreq < MIN_XCLK))
        return ERROR_DDI_CLOCKS_INVALID_XCLK_FREQ;

    //--------------------------------------------------------------------------
    // Calculate the divider and frequency.  
    //--------------------------------------------------------------------------
    if((rtn = ddi_clocks_CalculateRefXtalDiv(&u32XclkFreq,&u32IntDiv)) != SUCCESS)
        return rtn;

    //--------------------------------------------------------------------------
    // Set the divider.
    //--------------------------------------------------------------------------
    if((rtn = hw_clkctrl_SetXclkDiv(u32IntDiv,FALSE)) != SUCCESS)
        return rtn;

    //--------------------------------------------------------------------------
    // Save and return the new XCLK frequency.
    //--------------------------------------------------------------------------
    g_CurrentClockFreq.Xclk = u32XclkFreq;
    *u32Freq_kHz = u32XclkFreq;
    return SUCCESS;
}

/////////////////////////////////////////////////////////////////////////////////
//! \brief Gets the Xclk frequency
//!
//! \fntype Function
//!
//! \retval Xclk frequency in kHz
/////////////////////////////////////////////////////////////////////////////////
uint32_t ddi_clocks_GetXclk(void)
{
    uint32_t ClkFreq;
    
    //--------------------------------------------------------------------------
    // XCLK is always based on the 24MHz crystal.
    //--------------------------------------------------------------------------
    {
        //----------------------------------------------------------------------
        // Start with 24MHz
        //----------------------------------------------------------------------
        ClkFreq = XTAL_24MHZ_IN_KHZ;    

        //----------------------------------------------------------------------
        // Divide by the XCLK integer divider to get the frequency.
        //----------------------------------------------------------------------
        ClkFreq /= HW_CLKCTRL_XBUS.B.DIV;
    }    
    
    return ClkFreq;    

}

/////////////////////////////////////////////////////////////////////////////////
////////////////////////////////  EOF  //////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////

