/////////////////////////////////////////////////////////////////////////////////
//! \addtogroup hw_clocks
//! @{
//
// Copyright(C) 2007 SigmaTel, Inc.
//
//! \file hw_clocks.c
//! \brief Master clocks (PLL, PCLK, HCLK, XCLK) and module clocks (EMI, SSP,
//! \brief GPMI, IROV, IR, PIX, SAIF, etc..) hardware interface routines.
//!
//! \date March 2007
//!
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
//  Includes and external references
/////////////////////////////////////////////////////////////////////////////////
#include "hw_clocks_common.h"

/////////////////////////////////////////////////////////////////////////////////
// Externs
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
// Definitions
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Prototypes
/////////////////////////////////////////////////////////////////////////////////


/////////////////////////////////////////////////////////////////////////////////
// Variables
/////////////////////////////////////////////////////////////////////////////////



/////////////////////////////////////////////////////////////////////////////////
// Code
/////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////
//! \brief Initialize hardware for clock control
//! 
//! \retval SUCCESS
/////////////////////////////////////////////////////////////////////////////////
RtStatus_t hw_clkctrl_Init(void)
{
//    uint32_t StartTime;    

    //--------------------------------------------------------------------------
    // Power on the PLL
    //--------------------------------------------------------------------------
    hw_clkctrl_PowerPll(true);

    //--------------------------------------------------------------------------
    // Wait 10 microseconds while the PLL stabalizes.
    //--------------------------------------------------------------------------
//    StartTime = hw_digctl_GetCurrentTime();
    //while(!hw_digctl_CheckTimeOut(StartTime, 10));
	udelay(10);

    //--------------------------------------------------------------------------
    // Clear the EMI PFD clock gate to prep for external memory.  
    //--------------------------------------------------------------------------
    hw_clkctrl_SetPfdRefEmiGate(false);

    //--------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------


    //--------------------------------------------------------------------------
    //
    //--------------------------------------------------------------------------


    return SUCCESS;
}

RtStatus_t hw_clkctrl_InitPowerSavings(void)
{
    //--------------------------------------------------------------------------
    // Enable interrupt wait to gate unused CPU clocks to save power.  
    //--------------------------------------------------------------------------
    hw_clkctrl_SetPclkInterruptWait(true);    

    //--------------------------------------------------------------------------
    // Select conditions to use HCLK auto-slow.
    //--------------------------------------------------------------------------
    hw_clkctrl_EnableHclkModuleAutoSlow(APBHDMA_AUTOSLOW,true);
    hw_clkctrl_EnableHclkModuleAutoSlow(TRAFFIC_AUTOSLOW,true);
    hw_clkctrl_EnableHclkModuleAutoSlow(CPU_DATA_AUTOSLOW,true);
    hw_clkctrl_EnableHclkModuleAutoSlow(CPU_INSTR_AUTOSLOW,true);

    //--------------------------------------------------------------------------
    // Set the HCLK auto-slow divider to 32.
    //--------------------------------------------------------------------------
    hw_clocks_SetHclkAutoSlowDivider(SLOW_DIV_BY32);

    //--------------------------------------------------------------------------
    // Enable HCLK auto-slow.
    //--------------------------------------------------------------------------
    hw_clocks_EnableHclkAutoSlow(true);


    return SUCCESS;

}

RtStatus_t hw_clkctrl_UndoPowerSavings(void)
{
    //--------------------------------------------------------------------------
    // Disable interrupt wait for speed.
    //--------------------------------------------------------------------------
    hw_clkctrl_SetPclkInterruptWait(false);

    //--------------------------------------------------------------------------
    // Select conditions to use HCLK auto-slow.
    //--------------------------------------------------------------------------
    hw_clkctrl_EnableHclkModuleAutoSlow(APBHDMA_AUTOSLOW,false);
    hw_clkctrl_EnableHclkModuleAutoSlow(TRAFFIC_AUTOSLOW,false);
    hw_clkctrl_EnableHclkModuleAutoSlow(CPU_DATA_AUTOSLOW,false);
    hw_clkctrl_EnableHclkModuleAutoSlow(CPU_INSTR_AUTOSLOW,false);

    //--------------------------------------------------------------------------
    // Set the HCLK auto-slow divider to 32.
    //--------------------------------------------------------------------------
    hw_clocks_SetHclkAutoSlowDivider(SLOW_DIV_BY1);

    //--------------------------------------------------------------------------
    // Enable HCLK auto-slow.
    //--------------------------------------------------------------------------
    hw_clocks_EnableHclkAutoSlow(false);


    return SUCCESS;
}

////////////////////////////////////////////////////////////////////////////////
// End of file
////////////////////////////////////////////////////////////////////////////////
//! @}
